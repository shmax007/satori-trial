<script type="module">
  // ✅ Import Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, Timestamp } 
    from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  // ✅ Firebase Config (your project details)
  const firebaseConfig = {
  apiKey: "AIzaSyCVZKRIoXIwGkUhdDlZf9Q8BkZU1uqpQ8I",
  authDomain: "satori-strength.firebaseapp.com",
  projectId: "satori-strength",
  storageBucket: "satori-strength.firebasestorage.app",
  messagingSenderId: "255120260921",
  appId: "1:255120260921:web:d69ed3858babae24e232e8"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ✅ Config
  const ADMIN_PASSWORD = "satori2953";

  // Time slots
  const timeSlots = [
    { id: 1, start: "6:00", end: "8:00", maxCapacity: 8 },
    { id: 2, start: "9:00", end: "10:00", maxCapacity: 8 },
    { id: 3, start: "12:30", end: "14:00", maxCapacity: 8 },
    { id: 4, start: "17:30", end: "18:30", maxCapacity: 8 },
    { id: 5, start: "18:30", end: "19:30", maxCapacity: 8 },
    { id: 6, start: "19:30", end: "20:30", maxCapacity: 8 }
  ];

  // DOM elements
  const timeSlotsContainer = document.getElementById('timeSlots');
  const reservationForm = document.getElementById('reservationForm');
  const selectedTimeInput = document.getElementById('selectedTime');
  const successAlert = document.getElementById('successAlert');
  const errorAlert = document.getElementById('errorAlert');
  const allReservations = document.getElementById('allReservations');
  const adminSection = document.getElementById('adminSection');
  const adminAccess = document.getElementById('adminAccess');
  const adminPassword = document.getElementById('adminPassword');
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');

  let selectedTimeSlot = null;
  let allReservationsData = [];
  let isAdmin = false;

  // ✅ Initialize app
  function initializeAppCustom() {
    checkAdminStatus();
    loadTimeSlots();
    setupEventListeners();
  }

  function checkAdminStatus() {
    if (sessionStorage.getItem('satoriAdmin') === 'true') {
      isAdmin = true;
      adminSection.style.display = 'block';
      adminAccess.style.display = 'none';
      loadAllReservations();
    }
  }

  // ✅ Load time slots from Firestore
  async function loadTimeSlots() {
    const reservations = await getReservations();
    timeSlotsContainer.innerHTML = '';
    timeSlots.forEach(slot => {
      const reservationsForSlot = reservations.filter(r => r.timeSlotId == slot.id);
      const currentCount = reservationsForSlot.length;
      const isFull = currentCount >= slot.maxCapacity;
      const isSoon = isTimeSlotSoon(slot);

      const timeSlotElement = document.createElement('div');
      timeSlotElement.className = `time-slot ${isFull ? 'full' : ''} ${isSoon ? 'soon' : ''} ${selectedTimeSlot === slot.id ? 'selected' : ''}`;
      timeSlotElement.innerHTML = `
        <h3>${slot.start} - ${slot.end}</h3>
        <div class="count">${currentCount}/${slot.maxCapacity} reserved</div>
        ${isSoon ? '<div><small><i class="fas fa-clock"></i> Starting soon!</small></div>' : ''}
      `;

      if (!isFull) {
        timeSlotElement.addEventListener('click', () => selectTimeSlot(slot.id));
      }

      timeSlotsContainer.appendChild(timeSlotElement);
    });
  }

  function isTimeSlotSoon(slot) {
    const now = new Date();
    const slotStartTime = new Date();
    const [startHour, startMinute] = slot.start.split(':').map(Number);
    slotStartTime.setHours(startHour, startMinute, 0, 0);
    const oneHourFromNow = new Date(now.getTime() + 60 * 60 * 1000);
    return slotStartTime > now && slotStartTime <= oneHourFromNow;
  }

  function selectTimeSlot(timeSlotId) {
    selectedTimeSlot = timeSlotId;
    const slot = timeSlots.find(s => s.id === timeSlotId);
    selectedTimeInput.value = `${slot.start} - ${slot.end}`;
    loadTimeSlots();
  }

  // ✅ Load all reservations (admin panel)
  async function loadAllReservations() {
    if (!isAdmin) return;
    const reservations = await getAllReservations();
    allReservationsData = reservations;
    allReservations.innerHTML = '';

    if (reservations.length === 0) {
      allReservations.innerHTML = '<p>No reservations found.</p>';
      return;
    }

    const groupedByDate = {};
    reservations.forEach(reservation => {
      const date = reservation.date || 'Unknown Date';
      if (!groupedByDate[date]) groupedByDate[date] = [];
      groupedByDate[date].push(reservation);
    });

    for (const [date, dateReservations] of Object.entries(groupedByDate)) {
      const dateHeader = document.createElement('h4');
      dateHeader.textContent = `Reservations for ${date}`;
      dateHeader.style.marginTop = '20px';
      dateHeader.style.marginBottom = '10px';
      dateHeader.style.color = '#f1c40f';
      allReservations.appendChild(dateHeader);

      dateReservations.forEach(reservation => {
        const slot = timeSlots.find(s => s.id == reservation.timeSlotId);
        const timeSlotText = slot ? `${slot.start} - ${slot.end}` : 'Unknown Time';
        const reservationElement = document.createElement('div');
        reservationElement.className = 'reservation-item';
        reservationElement.innerHTML = `
          <div class="reservation-info">
            <h4>${reservation.name}</h4>
            <p>${timeSlotText} | ${reservation.email}</p>
            <small>Booked on: ${reservation.bookingDate || 'Unknown'}</small>
          </div>
          <button class="delete-btn" data-id="${reservation.id}">Delete</button>
        `;
        allReservations.appendChild(reservationElement);
      });
    }

    document.querySelectorAll('.delete-btn').forEach(button => {
      button.addEventListener('click', async (e) => {
        const id = e.target.getAttribute('data-id');
        if (confirm('Are you sure you want to delete this reservation?')) {
          await deleteReservation(id);
          loadAllReservations();
          loadTimeSlots();
        }
      });
    });
  }

  // ✅ Event Listeners
  function setupEventListeners() {
    reservationForm.addEventListener('submit', handleReservationSubmit);
    loginBtn.addEventListener('click', () => {
      if (adminPassword.value === ADMIN_PASSWORD) {
        isAdmin = true;
        sessionStorage.setItem('satoriAdmin', 'true');
        adminSection.style.display = 'block';
        adminAccess.style.display = 'none';
        loadAllReservations();
      } else {
        loginError.style.display = 'block';
        adminPassword.value = '';
      }
    });

    adminPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loginBtn.click();
    });

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tabId = button.getAttribute('data-tab');
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        tabContents.forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabId}-tab`).classList.add('active');
      });
    });
  }

  // ✅ Reservation Submit
  async function handleReservationSubmit(e) {
    e.preventDefault();
    if (!selectedTimeSlot) {
      showAlert('Please select a time slot.', 'error');
      return;
    }
    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;

    const slot = timeSlots.find(s => s.id === selectedTimeSlot);
    const reservations = await getReservations();
    const reservationsForSlot = reservations.filter(r => r.timeSlotId == selectedTimeSlot);

    if (reservationsForSlot.length >= slot.maxCapacity) {
      showAlert('This time slot is now full. Please select another.', 'error');
      loadTimeSlots();
      return;
    }

    const reservation = {
      name,
      email,
      timeSlotId: selectedTimeSlot,
      date: new Date().toISOString().split('T')[0],
      bookingDate: new Date().toLocaleString()
    };

    await saveReservation(reservation);
    showAlert('Reservation successfully made!', 'success');

    reservationForm.reset();
    selectedTimeSlot = null;
    selectedTimeInput.value = '';
    loadTimeSlots();
    if (isAdmin) loadAllReservations();
  }

  function showAlert(message, type) {
    const alertElement = type === 'success' ? successAlert : errorAlert;
    alertElement.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle"></i> ${message}`;
    alertElement.style.display = 'block';
    setTimeout(() => { alertElement.style.display = 'none'; }, 5000);
  }

  // ✅ Firestore functions
  async function getReservations() {
    const today = new Date().toISOString().split('T')[0];
    const q = query(collection(db, "reservations"), where("date", "==", today));
    const snap = await getDocs(q);
    return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  }

  async function getAllReservations() {
    const snap = await getDocs(collection(db, "reservations"));
    return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  }

  async function saveReservation(reservation) {
    await addDoc(collection(db, "reservations"), { ...reservation, createdAt: Timestamp.now() });
  }

  async function deleteReservation(id) {
    await deleteDoc(doc(db, "reservations", id));
  }

  // ✅ Init
  document.addEventListener('DOMContentLoaded', initializeAppCustom);
</script>
